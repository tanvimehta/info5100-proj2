<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet"
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<style>
body {
	width: 1200px;
	margin: 100px auto;
	font: 10px sans-serif;
	opacity: 0.8;
}

svg text {
	font-size: 12px;
	margin: 100px auto;
}

rect {
	shape-rendering: crispEdges;
}

.axis path, .axis line {
	fill: none;
	stroke: #000;
	shape-rendering: crispEdges;
}

.bar {
	fill: steelblue;
}

.x.axis path {
	display: none;
}

.imgClass {
	max-width: 100%;
	height: auto;
}

#logoSVG {
	margin: 0 auto;
	display: block;
}

#bullet {
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
	margin: auto;
	padding-top: 40px;
	position: relative;
	width: 960px;
}

button {
	position: absolute;
	right: 10px;
	top: 10px;
}

.bullet {
	font: 10px sans-serif;
}

.bullet .marker {
	stroke: #000;
	stroke-width: 2px;
}

.bullet .tick line {
	stroke: #666;
	stroke-width: .5px;
}

.bullet .range.s0 {
	fill: #eee;
}

.bullet .range.s1 {
	fill: #ddd;
}

.bullet .range.s2 {
	fill: #ccc;
}

.bullet .measure.s0 {
	fill: lightsteelblue;
}

.bullet .measure.s1 {
	fill: steelblue;
}

.bullet .title {
	font-size: 14px;
	font-weight: bold;
}

.bullet .subtitle {
	fill: #999;
}
</style>
</head>
<body>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="js/biPartite.js"></script>
	<script type="text/javascript" src="js/companyInfo.js"></script>
	<script src="data/logos.json"></script>
	<script type="text/javascript" src="data/data.js"></script>

	<button>Update</button>
	<script src="js/companyInfo.js"></script>

	<script>
		logoName = "US";
		ethnicData = {};
	</script>

	<!-- Visualization 1 -->
	<table>
		<tr>
			<td>
				<div id="idCompanies" style="float: left"></div>
			</td>
			<td>
				<div id="moreInfo">
					<div id="moreInfoHeader" class="panel"
						style="height: 600px; width: 500px; border: 1px solid; align-content: center;">
						<div class="">More Information</div>
						<div class="" style="align-content: center;">
							<div id="logoSVG" style="height: 150px; width: 500px;">
								<p id="info"></p>
							</div>
							<div id="bullet" style="height: 150px; width: 500px;"></div>

						</div>
					</div>
				</div>
			</td>
		</tr>
	</table>

	<script>
		var width = 700, height = 600, margin = {
			b : 0,
			t : 40,
			l : 170,
			r : 50
		};
		var svg = d3.select("#idCompanies").append("svg").attr('width', width)
				.attr('height', (height + margin.b + margin.t)).append("g")
				.attr("transform",
						"translate(" + margin.l + "," + margin.t + ")");

		var data = [ {
			data : bP.partData(company_ethnic_data, 2),
			id : 'TechDiversity',
			header : [ "Company", "Ethnicity", "Diversity in Tech Companies" ]
		}, ];

		bP.draw(data, svg);
	</script>

	<!-- Visualization 2 -->
	<script>
		var margin = {
			top : 20,
			right : 20,
			bottom : 30,
			left : 40
		}, width = 960 - margin.left - margin.right, height = 500 - margin.top
				- margin.bottom;

		var education_levels = 3;

		var x = d3.scale.ordinal().rangeRoundBands([ 0, width ], .1);

		var band_width = width / 5; // number of years

		var y = d3.scale.linear().rangeRound([ height, 0 ]);

		var color = d3.scale.ordinal()
				.range(
						[ "#800026", "#feb24c", "#081d58", "#7fcdbb",
								"#004529", "#addd2f", "#49006a", "#fa9f00",
								"#ff00af", "#969696" ]);

		var xAxis = d3.svg.axis().scale(x).orient("bottom");

		var yAxis = d3.svg.axis().scale(y).orient("left").tickFormat(
				d3.format(".2s"));

		var svg = d3.select("body").append("svg").attr("width",
				width + margin.left + margin.right).attr("height",
				height + margin.top + margin.bottom).append("g").attr(
				"transform",
				"translate(" + margin.left + "," + margin.top + ")");

		d3.csv("Data/ugrad-stats.csv", function(error1, u_data) {
			d3.csv("Data/masters-stats.csv", function(error2, m_data) {
				d3.csv("Data/phd-stats.csv", function(error3, p_data) {

					if (error1)
						throw error1;
					if (error2)
						throw error2;
					if (error3)
						throw error3;

					color.domain(d3.keys(u_data[0]).filter(function(key) {
						return key !== "Year" && key !== "Total";
					}));

					u_data.forEach(function(d) {
						var y0 = 0;
						d.races = color.domain().map(function(name) {
							return {
								name : name,
								y0 : y0,
								y1 : y0 += +d[name]
							};
						});
						d.total = d.races[d.races.length - 1].y1;
					});
					m_data.forEach(function(d) {
						var y0 = 0;
						d.races = color.domain().map(function(name) {
							return {
								name : name,
								y0 : y0,
								y1 : y0 += +d[name]
							};
						});
						d.total = d.races[d.races.length - 1].y1;
					});
					p_data.forEach(function(d) {
						var y0 = 0;
						d.races = color.domain().map(function(name) {
							return {
								name : name,
								y0 : y0,
								y1 : y0 += +d[name]
							};
						});
						d.total = d.races[d.races.length - 1].y1;
					});

					u_data.sort(function(a, b) {
						return a.Year - b.Year;
					});
					m_data.sort(function(a, b) {
						return a.Year - b.Year;
					});
					p_data.sort(function(a, b) {
						return a.Year - b.Year;
					});

					x.domain(u_data.map(function(d) {
						return d.Year;
					}));
					y.domain([ 0, d3.max(u_data, function(d) {
						return d.total;
					}) ]);

					svg.append("g").attr("class", "x axis").attr("transform",
							"translate(0," + height + ")").call(xAxis);

					svg.append("g").attr("class", "y axis").call(yAxis);

					var ugrad = svg.selectAll(".ugrad").data(u_data).enter()
							.append("g").attr("class", "g")
							.attr("transform", function(d) {
								return "translate(" + x(d.Year) + ",0)";
							});
					var masters = svg.selectAll(".masters").data(m_data)
							.enter().append("g").attr("class", "g")
							.attr("transform", function(d) {
								return "translate(" + x(d.Year) + ",0)";
							});
					var phd = svg.selectAll(".phd").data(p_data).enter()
							.append("g").attr("class", "g")
							.attr("transform", function(d) {
								return "translate(" + x(d.Year) + ",0)";
							});

					ugrad.selectAll("rect").data(function(d) {
						return d.races;
					}).enter().append("rect").attr("width",
							x.rangeBand() / education_levels - 6).attr("y",
							function(d) {
								return y(d.y1);
							}).attr("height", function(d) {
						return y(d.y0) - y(d.y1);
					}).attr("class", "undergrad").style("fill", function(d) {
						return color(d.name);
					});
					masters.selectAll("rect").data(function(d) {
						return d.races;
					}).enter().append("rect").attr("width",
							x.rangeBand() / education_levels - 6).attr("y",
							function(d) {
								return y(d.y1);
							}).attr("height", function(d) {
						return y(d.y0) - y(d.y1);
					}).attr(
							"transform",
							function(d) {
								return "translate(" + x.rangeBand()
										/ education_levels + ",0)";
							}).attr("class", "mas").style("fill", function(d) {
						return color(d.name);
					});
					phd.selectAll("rect").data(function(d) {
						return d.races;
					}).enter().append("rect").attr("width",
							x.rangeBand() / education_levels).attr("y",
							function(d) {
								return y(d.y1);
							}).attr("height", function(d) {
						return y(d.y0) - y(d.y1);
					}).attr(
							"transform",
							function(d) {
								return "translate(" + 2 * x.rangeBand()
										/ education_levels + ",0)";
							}).attr("class", "pd").style("fill", function(d) {
						return color(d.name);
					});

					var legend = svg.selectAll(".legend").data(
							color.domain().slice().reverse()).enter().append(
							"g").attr("class", "legend").attr("transform",
							function(d, i) {
								return "translate(0," + i * 20 + ")";
							});

					legend.append("rect").attr("x", width - 18).attr("width",
							18).attr("height", 18).style("fill", color);

					legend.append("text").attr("x", width - 24).attr("y", 9)
							.attr("dy", ".35em").style("text-anchor", "end")
							.text(function(d) {
								return d;
							});
					legend.on('click', function(d) {
						d.disabled = !d.disabled;
						d3.transition().duration(600).each(function() {
							raceTransition(d);
						});
					});
				});
			});
		});

		var transUGrad = [];
		d3.csv("Data/ugrad-stats.csv", function(d) {
			return {
				Year : d.Year,
				Asian : d.Asian,
				Black : d.Black,
				Latino : d.Latino,
				White : d.White,
				Other : d.Other,
				Male : d.Male,
				Female : d.Female,
				NonResident : d.NonResident,
				Total : d.Total
			};
		}, function(data) {
			transUGrad = data;
		});

		var transMasters = [];
		d3.csv("Data/masters-stats.csv", function(d) {
			return {
				Year : d.Year,
				Asian : d.Asian,
				Black : d.Black,
				Latino : d.Latino,
				White : d.White,
				Other : d.Other,
				Male : d.Male,
				Female : d.Female,
				NonResident : d.NonResident,
				Total : d.Total
			};
		}, function(data) {
			transMasters = data;
		});

		var transPhd = [];
		d3.csv("Data/phd-stats.csv", function(d) {
			return {
				Year : d.Year,
				Asian : d.Asian,
				Black : d.Black,
				Latino : d.Latino,
				White : d.White,
				Other : d.Other,
				Male : d.Male,
				Female : d.Female,
				NonResident : d.NonResident,
				Total : d.Total
			};
		}, function(data) {
			transPhd = data;
		});

		//http://stackoverflow.com/questions/281264/remove-empty-elements-from-an-array-in-javascript
		Array.prototype.clean = function(deleteValue) {
			for (var i = 0; i < this.length; i++) {
				if (this[i] == deleteValue) {
					this.splice(i, 1);
					i--;
				}
			}
			return this;
		};

		function raceTransition(selectedLegend) {

			transUGrad.forEach(function(d) {
				var y0 = 0;
				d.races = color.domain().map(function(name) {
					if (name == selectedLegend) {
						return {
							name : name,
							y0 : y0,
							y1 : y0 += +d[name]
						}
					} else {
						return;
					}
					;
				});
				d.races.clean(undefined);
				d.total = d.races[d.races.length - 1].y1;
			});

			transMasters.forEach(function(d) {
				var y0 = 0;
				d.races = color.domain().map(function(name) {
					if (name == selectedLegend) {
						return {
							name : name,
							y0 : y0,
							y1 : y0 += +d[name]
						}
					} else {
						return;
					}
					;
				});
				d.races.clean(undefined);
				d.total = d.races[d.races.length - 1].y1;
			});

			transPhd.forEach(function(d) {
				var y0 = 0;
				d.races = color.domain().map(function(name) {
					if (name == selectedLegend) {
						return {
							name : name,
							y0 : y0,
							y1 : y0 += +d[name]
						}
					} else {
						return;
					}
					;
				});
				d.races.clean(undefined);
				d.total = d.races[d.races.length - 1].y1;
			});

			d3.selectAll(".undergrad").transition().remove();
			d3.selectAll(".mas").transition().remove();
			d3.selectAll(".pd").transition().remove();

			var ugrad = svg.selectAll(".ugrad").data(transUGrad).enter()
					.append("g").attr("class", "g").attr("transform",
							function(d) {
								return "translate(" + x(d.Year) + ",0)";
							});

			var masters = svg.selectAll(".masters").data(transMasters).enter()
					.append("g").attr("class", "g").attr("transform",
							function(d) {
								return "translate(" + x(d.Year) + ",0)";
							});

			var phd = svg.selectAll(".phd").data(transPhd).enter().append("g")
					.attr("class", "g").attr("transform", function(d) {
						return "translate(" + x(d.Year) + ",0)";
					});

			ugrad.selectAll("rect").data(function(d) {
				return d.races;
			}).enter().append("rect").transition().attr("width",
					x.rangeBand() / education_levels - 6).attr("y",
					function(d) {
						return y(d.y1);
					}).transition().attr("height", function(d) {
				return y(d.y0) - y(d.y1);
			}).attr("class", "undergrad").style("fill", function(d) {
				return color(d.name);
			});

			masters.selectAll("rect").data(function(d) {
				return d.races;
			}).enter().append("rect").transition().attr("width",
					x.rangeBand() / education_levels - 6).attr("y",
					function(d) {
						return y(d.y1);
					}).transition().attr("height", function(d) {
				return y(d.y0) - y(d.y1);
			}).attr("transform", function(d) {
				return "translate(" + x.rangeBand() / education_levels + ",0)";
			}).attr("class", "mas").style("fill", function(d) {
				return color(d.name);
			});

			phd.selectAll("rect").data(function(d) {
				return d.races;
			}).enter().append("rect").transition().attr("width",
					x.rangeBand() / education_levels - 6).attr("y",
					function(d) {
						return y(d.y1);
					}).transition().attr("height", function(d) {
				return y(d.y0) - y(d.y1);
			}).attr(
					"transform",
					function(d) {
						return "translate(" + 2 * x.rangeBand()
								/ education_levels + ",0)";
					}).attr("class", "pd").style("fill", function(d) {
				return color(d.name);
			});

		}
	</script>
</body>
</html>